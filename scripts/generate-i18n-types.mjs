#!/usr/bin/env node
/**
 * Generates i18n resources from translation JSON files.
 *
 * Can be used as:
 * 1. Standalone script: node scripts/generate-i18n-types.mjs
 * 2. Vite plugin: import i18nTypesPlugin from './scripts/generate-i18n-types.mjs'
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const LOCALES_DIR = 'src/base/i18n/locales/en';
const OUTPUT = 'src/base/i18n/resources.ts';

function getJsonFiles(rootDir) {
  const localesPath = path.join(rootDir, LOCALES_DIR);
  return fs.readdirSync(localesPath)
    .filter((f) => f.endsWith('.json'))
    .sort()
    .map((f) => ({ filename: f, namespace: f.replace('.json', '') }));
}

function generate(jsonFiles) {
  const imports = jsonFiles
    .map((f) => `import ${f.namespace} from './locales/en/${f.filename}';`)
    .join('\n');

  const entries = jsonFiles.map((f) => `    ${f.namespace},`).join('\n');

  const namespaceEntries = jsonFiles
    .map((f) => `  ${f.namespace}: '${f.namespace}',`)
    .join('\n');

  const allNamespacesList = jsonFiles
    .map((f) => `  ns.${f.namespace},`)
    .join('\n');

  return `/**
 * AUTO-GENERATED - DO NOT EDIT!
 * Generated by: pnpm generate:i18n-types
 *
 * To add a new namespace: create a JSON file in locales/en/
 */
${imports}

/**
 * Namespace constants for type-safe useTranslation calls.
 * Usage: useTranslation([ns.common, ns.processes])
 */
export const ns = {
${namespaceEntries}
} as const;

/**
 * Array of all available namespaces.
 * Usage: useTranslation(allNamespaces)
 */
export const allNamespaces = [
${allNamespacesList}
] as const;

export const resources = {
  en: {
${entries}
  },
} as const;

export type Resources = (typeof resources)['en'];
export type Namespace = keyof Resources;
`;
}

function writeIfChanged(filePath, content) {
  const current = fs.existsSync(filePath) ? fs.readFileSync(filePath, 'utf-8') : '';
  if (current !== content) {
    fs.writeFileSync(filePath, content, 'utf-8');
    return true;
  }
  return false;
}

function regenerate(rootDir, silent = false) {
  const jsonFiles = getJsonFiles(rootDir);
  if (jsonFiles.length === 0) {
    console.error('[i18n] No JSON files found in', LOCALES_DIR);
    return false;
  }

  const content = generate(jsonFiles);
  const outputPath = path.join(rootDir, OUTPUT);
  const changed = writeIfChanged(outputPath, content);

  if (changed && !silent) {
    console.log(`[i18n] Generated resources.ts (${jsonFiles.length} namespaces)`);
  }
  return changed;
}

/**
 * Vite plugin for auto-regenerating i18n resources during dev.
 */
export default function i18nTypesPlugin() {
  let rootDir = process.cwd();

  return {
    name: 'vite-plugin-i18n-types',

    configResolved(config) {
      rootDir = config.root;
    },

    buildStart() {
      regenerate(rootDir);
    },

    configureServer(server) {
      const localesPath = path.join(rootDir, LOCALES_DIR);
      server.watcher.add(path.join(localesPath, '*.json'));

      const handle = (file, action) => {
        if (file.startsWith(localesPath) && file.endsWith('.json')) {
          console.log(`[i18n] ${action}: ${path.basename(file)}`);
          if (regenerate(rootDir)) {
            server.ws.send({ type: 'full-reload' });
          }
        }
      };

      server.watcher.on('add', (f) => handle(f, 'Added'));
      server.watcher.on('unlink', (f) => handle(f, 'Removed'));
      server.watcher.on('change', (f) => handle(f, 'Changed'));
    },
  };
}

// Run standalone if executed directly
const __filename = fileURLToPath(import.meta.url);
const isMain = process.argv[1] === __filename;

if (isMain) {
  const rootDir = path.resolve(path.dirname(__filename), '..');
  const jsonFiles = getJsonFiles(rootDir);
  console.log(`Found ${jsonFiles.length} namespaces: ${jsonFiles.map(f => f.namespace).join(', ')}`);

  const content = generate(jsonFiles);
  fs.writeFileSync(path.join(rootDir, OUTPUT), content);
  console.log('Generated:', OUTPUT);
}
